#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

void print_banner() {
    printf("\n");
    printf("╔═══════════════════════════════════════════════════════════╗\n");
    printf("║    ███╗   ██╗███████╗ ██████╗ ███╗   ██╗                 ║\n");
    printf("║    ████╗  ██║██╔════╝██╔═══██╗████╗  ██║                 ║\n");
    printf("║    ██╔██╗ ██║█████╗  ██║   ██║██╔██╗ ██║                 ║\n");
    printf("║    ██║╚██╗██║██╔══╝  ██║   ██║██║╚██╗██║                 ║\n");
    printf("║    ██║ ╚████║███████╗╚██████╔╝██║ ╚████║                 ║\n");
    printf("║    ╚═╝  ╚═══╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝                 ║\n");
    printf("║                                                           ║\n");
    printf("║         ██████╗ ██╗   ██╗██╗     ███████╗███████╗        ║\n");
    printf("║         ██╔══██╗██║   ██║██║     ██╔════╝██╔════╝        ║\n");
    printf("║         ██████╔╝██║   ██║██║     ███████╗█████╗          ║\n");
    printf("║         ██╔═══╝ ██║   ██║██║     ╚════██║██╔══╝          ║\n");
    printf("║         ██║     ╚██████╔╝███████╗███████║███████╗        ║\n");
    printf("║         ╚═╝      ╚═════╝ ╚══════╝╚══════╝╚══════╝        ║\n");
    printf("║                                                           ║\n");
    printf("║              🎮 GAME SCORE VALIDATOR v2.1 🎮             ║\n");
    printf("║                  Authenticated System                     ║\n");
    printf("╚═══════════════════════════════════════════════════════════╝\n");
    printf("\n");
}

void show_menu() {
    printf("┌─────────────────────────────────────────────────────────┐\n");
    printf("│                    🕹️  MAIN MENU  🕹️                    │\n");
    printf("├─────────────────────────────────────────────────────────┤\n");
    printf("│  [1] Validate New High Score                           │\n");
    printf("│  [2] Check Game Statistics                             │\n");
    printf("│  [3] Backup Score Database                             │\n");
    printf("│  [4] System Diagnostics                               │\n");
    printf("│  [5] Exit                                              │\n");
    printf("└─────────────────────────────────────────────────────────┘\n");
    printf("\n💫 Select option: ");
}

void validate_score() {
    char player_name[100];
    int score;
    char game_name[100];
    
    printf("\n🎯 SCORE VALIDATION MODULE\n");
    printf("═══════════════════════════\n");
    
    printf("🎮 Game name: ");
    fgets(game_name, sizeof(game_name), stdin);
    game_name[strcspn(game_name, "\n")] = 0;
    
    printf("🏆 Player name: ");
    fgets(player_name, sizeof(player_name), stdin);
    player_name[strcspn(player_name, "\n")] = 0;
    
    printf("⭐ Score: ");
    scanf("%d", &score);
    getchar(); // consume newline
    
    printf("\n✨ Validating score for %s in %s...\n", player_name, game_name);
    printf("🔍 Running integrity check...\n");
    
    // Vulnérabilité : appel à 'grep' sans chemin absolu
    char command[512];
    snprintf(command, sizeof(command), "grep -i \"%s\" /opt/neonpulse/scores.db", player_name);
    
    printf("🔧 Executing: %s\n", command);
    system(command);
    
    printf("✅ Score validation completed!\n");
    printf("📊 Score %d for %s has been processed.\n\n", score, player_name);
}

void check_stats() {
    printf("\n📈 GAME STATISTICS\n");
    printf("══════════════════\n");
    printf("🎮 Total games played: 1337\n");
    printf("🏆 Active players: 42\n");
    printf("⭐ Highest score: 999999 (PAC-MAN)\n");
    printf("🔥 Most popular game: Galaga\n");
    printf("📅 Last update: 1985-10-26\n\n");
}

void backup_database() {
    printf("\n💾 DATABASE BACKUP MODULE\n");
    printf("═════════════════════════\n");
    printf("🔄 Initializing backup process...\n");
    
    // Vulnérabilité : appel à 'tar' sans chemin absolu
    printf("📦 Creating archive...\n");
    system("tar -czf /tmp/scores_backup.tar.gz /opt/neonpulse/scores.db");
    
    printf("✅ Backup completed successfully!\n");
    printf("📁 Archive saved to: /tmp/scores_backup.tar.gz\n\n");
}

void system_diagnostics() {
    printf("\n🔧 SYSTEM DIAGNOSTICS\n");
    printf("═════════════════════\n");
    printf("🖥️  Running system checks...\n");
    
    // Vulnérabilité : appel à 'ps' sans chemin absolu
    printf("📊 Active processes:\n");
    system("ps aux | grep -E '(apache|mysql|ssh)' | head -5");
    
    printf("\n💻 System load:\n");
    // Vulnérabilité : appel à 'uptime' sans chemin absolu
    system("uptime");
    
    printf("\n💽 Disk usage:\n");
    // Vulnérabilité : appel à 'df' sans chemin absolu
    system("df -h | grep -E '(/$|/home)' || echo 'Unable to check disk usage'");
    
    printf("\n✅ Diagnostics completed!\n\n");
}

int main() {
    setuid(0);
    setgid(0);

    int choice;
    
    print_banner();
    printf("🔐 Welcome to NeonPulse Arcade Score Management System\n");
    printf("🎯 Authenticated as: %s (UID: %d)\n", getenv("USER"), getuid());
    printf("⚡ System ready for score validation and management.\n\n");
    
    while(1) {
        show_menu();
        scanf("%d", &choice);
        getchar(); // consume newline
        
        switch(choice) {
            case 1:
                validate_score();
                break;
            case 2:
                check_stats();
                break;
            case 3:
                backup_database();
                break;
            case 4:
                system_diagnostics();
                break;
            case 5:
                printf("\n🌟 Thank you for using NeonPulse Score Validator!\n");
                printf("🎮 Keep the retro spirit alive! 🕹️\n\n");
                exit(0);
            default:
                printf("\n❌ Invalid option! Please select 1-5.\n\n");
        }
        
        printf("Press Enter to continue...");
        getchar();
        printf("\n");
    }
    
    return 0;
}